<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphQl Interface</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/graphql.js@0.6.6/graphql.min.js"></script>
    <script src="https://unpkg.com/prettier@2.0.5/standalone.js"></script>
    <script src="https://unpkg.com/prettier@2.0.5/parser-graphql.js"></script>
    <script>{{ index.js }}</script>
    <script>{{ renderHelpers.js }}</script>
</head>

<body>
    <form action="#" name="config">
        <input id="endpoint" type="text" name="endpoint" id="" placeholder="Endpoint" value="http://dev5-2.stg.synup.com/graphql">
        <select name="token_type" id="">
            <option value="Bearer">Bearer</option>
            <option value="Internal">Internal</option>
            <option value="API">API</option>
        </select>
        <input id="token" type="text" name="token" id="" placeholder="Token" value="eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ1c2VyX2lkIjoxNTcsImFjY291bnRfaWQiOjEyOCwicm9sZV9pZCI6MTgzODIsIm5hbWUiOiJMZXp3b24iLCJ1c2VyX3R5cGUiOiJBZ2VuY3kiLCJqdGkiOiI0NDdiM2UxZS0wYWQwLTQyYjQtOTA2MS01YzJjMGQyYjhkM2QiLCJyb2xlX3R5cGUiOiJhZG1pbiIsInJvbGVfbmFtZSI6IkFkbWluIn0.q1nhYh5pWgn44-2FPRmQSeyv5Bq3qGoDJXQCTy0RgyBr77jCt4ZTicQJhFYAzuQHWzfZgT3rmL0Z8aoMg4Bz1RNKQD8BCbgQAhgIS8FxgCJON_hSE-PFPe14CGyS8_phaSe31g9nrATwwfVUotDS9YCuZiiE6KYw9bSqxTEC6gYq8zQgp7JtGJ4-sJPn3Z68S5vmwvHAFJuc45FfmLbubh18gVu0k5gxbblm8T4strYyxUhNRty5qYg8TN45w3oXLROBJn-NuvbEcNOrsyqzTSB5Me-mPg3PlIE5AZ4zS5OIDHs8tfh5Mq0yATJAQeJ0yObM9dCqN5Q1xwNSb6ffSw">
        <input id="submit_button" type="submit" value="Submit" name="submit_button">
    </form>


</body>
<script>

    document.forms.config.addEventListener('submit', (e) => {
        e.preventDefault()
        let submit_button = e.target.submit_button
        let endpoint = e.target.endpoint.value
        let tokenType = e.target.token_type.value
        let token = e.target.token.value
        
        submit_button.setAttribute('disabled', true)

        getClient(endpoint,`${tokenType} ${token}`)
        .then((client) => {
            submit_button.removeAttribute('disabled')
            let container = document.getElementById('container')
            if(container != null){ container.remove() }

            container = document.createElement('div')
            container.id = 'container'
            document.body.appendChild(container)
            
            let queryList = client.getFullList().sort()
            
            let querySelectElement = document.createElement('select')
            queryList.forEach((query) => {
                let option = document.createElement('option')
                option.setAttribute('value', query)
                option.innerText = query
                querySelectElement.appendChild(option)
            })
            container.appendChild(querySelectElement)
            
            querySelectElement.addEventListener('change', function(e){
                query = e.target.value
                
                let subContainer = document.getElementById('subContainer')
                if(subContainer != null){ subContainer.remove() }

                subContainer = document.createElement('div')
                subContainer.id = 'subContainer'
                container.appendChild(subContainer)
               

                let payload = client.resolveQueryInput(query)
                let output = parseObject(payload)
                htmlRender = renderItems(output)
                subContainer.appendChild(htmlRender)

                button = document.createElement('button')
                button.setAttribute('value', 'Submit')
                button.innerText = 'Submit'
                subContainer.appendChild(button)


                panelHeadings = document.getElementsByClassName('panel')
                let addPanelBody = function(e){
                    if (e.target.nodeName != "A"){
                        e.preventDefault()
                    }
                    let typeName = e.target.innerText
                    let payload = client.resolveType(typeName)
                    let output = parseObject(payload)
                    let htmlRender = renderItems(output)
                    e.target.parentElement.parentElement.nextElementSibling.firstChild.appendChild(htmlRender)
                }

                for (let item of panelHeadings) {
                    item.addEventListener('click', addPanelBody)
                }

                button.addEventListener('click', function(e){
                    let variables = parseInput(output)
                    let outputPayload = client.getOutputQuery(query)
                    if(Object.keys(variables).length != 0){
                        
                        let params = Object.entries(variables).map(([key, value])=>{
                            return `${key}: ${JSON.stringify(value)}`
                        }).join(", ")
                        params = `(${params})`


                        let idx = outputPayload.indexOf('{')
                        idx = outputPayload.indexOf('{', idx + 1)
                        outputPayload = outputPayload.slice(0, --idx) + params + outputPayload.slice(idx)
                    }
                    

                    body = {
                        'query': outputPayload,
                        'variables': variables
                    }

                    preTag = document.createElement('pre')
                    subContainer.appendChild(preTag)
                    preTag.innerHTML = JSON.stringify(body, undefined, 4).replace(/\n/g, "<br />")

                    client.execute(outputPayload).then(async (response) => {
                        response = await response.json();
                        responseTag = document.createElement('pre')
                        subContainer.appendChild(responseTag)
                        responseTag.innerHTML = JSON.stringify(response, undefined, 4)
                    }).catch(e=> console.log(e))
                })
            })
        })
    })

    
</script>

</html>